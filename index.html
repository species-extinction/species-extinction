<!DOCTYPE html>
<head>
  <meta charset="utf-8" />
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <style>
    body {
      margin: 0;
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }
    .country:hover {
      fill: #00004c;
    }
    .hidden {
      display: none;
    }
    div.tooltip {
      color: #222;
      background-color: #fff;
      padding: 1.5em;
      text-shadow: #f5f5f5 0 1px 0;
      border-radius: 2px;
      opacity: 0.9;
      position: absolute;
    }
    .container {
      display: flex;
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="map"></div>
    <div id="infos">
      <div id="generalInfos">
        <h1>Ici on affichera les infos sur le pays sélectionné</h1>
      </div>
      <div id="graph1"></div>
      <div id="graph2"></div>
    </div>
  </div>
  <script>
    var width = 1152,
      height = 1152;

    var svg = d3
      .select("#map")
      .append("svg")
      .attr("width", width)
      .attr("height", height);

    //var zoom = d3.behavior.zoom().scaleExtent([1, 8]).on("zoom", move);

    var tooltip = d3
      .select("body")
      .append("div")
      .attr("class", "hidden tooltip");

    // On rajoute un groupe englobant toute la visualisation pour plus tard
    var g = svg.append("g");

    // Carte du monde
    projection = d3
      .geoNaturalEarth1()
      .translate([width / 2, height / 2])
      .scale(225);

    var path = d3.geoPath().projection(projection);

    // Range et Domain pour la coloration de la carte
    var color = d3
      .scaleQuantize()
      .range([
        "#ffffcc",
        "#ffff7f",
        "#ffff00",
        "#ffbf7f",
        "#ffb266",
        "#ff8000",
        "#ff4c4c",
        "#ff0000",
        "#7f0000"
      ])
      .domain([1, 50]);

    var pieheight = 350;
    var piewidth = 350;
    var piesvg = d3
      .select("#graph1")
      .append("svg")
      .attr("width", piewidth)
      .attr("height", pieheight)
      .append("g")
      .attr(
        "transform",
        "translate(" + piewidth / 2 + "," + pieheight / 2 + ")"
      );

    // Dessine le pie chart des causes d'extinctions
    function drawPieChart(keys, values) {
      //Pour effacer le précédent affichage
      piesvg.selectAll("path").remove();
      var piecolor = d3.interpolateRainbow;

      // Génère le pie chart
      var pie = d3.pie().value(function (d) {
        return d;
      });
      // Génère les arcs/parties du pie chart
      var arc = d3
        .arc()
        .innerRadius(0)
        .outerRadius(pieheight / 2);

      // Trace les parties du graphe
      piesvg
        .selectAll("arc")
        .data(pie(values))
        .enter()
        .append("path")
        .attr("d", arc)
        .attr("fill", function (d, i) {
          return piecolor(i / values.length);
        })
        .attr("stroke", "black")
        .style("stroke-width", "1px")
        .style("opacity", 0.8)
        .on("mousemove", function (event, d) {
          //console.log(d);
          tooltip
            .classed("hidden", false)
            .attr(
              "style",
              "left:" + (event.x + 15) + "px; top:" + (event.y - 15) + "px"
            )
            // Le tooltip contient la cause d'extinction représentée par la partie survolée
            // et le nombre d'espèces disparues par cette cause.
            .html(
              "<div><b>Cause of extinction : </b>" +
                keys[d.index] +
                "<br /><b>Species extincted by this cause : </b>" +
                d.value +
                "</div>"
            );
        })
        .on("mouseout", function (event, d) {
          tooltip.classed("hidden", true);
        });
    }

    // On lit le fichier csv
    d3.dsv(";", "extinct_species.csv").then(function (csvdata) {
      // On lit le fichier json
      d3.json("world.geojson").then(function (jsondata) {
        jsondata.features.forEach((e) => {
          e.properties.nbspecies = 0;
          e.properties.speciesList = [];
          e.properties.extinctionCauses = [];
        });
        // On parcourt le csv et on récupère le pays et le nom de l'espèce de la ligne courante
        for (var i = 0; i < csvdata.length; i++) {
          var country = csvdata[i].FormerDistribution;
          var speciesName = csvdata[i].CommonName;
          // Certaines espèces n'ont pas de nom commun donc on prend le nom scientifique
          if (speciesName == "Unknown") {
            speciesName = csvdata[i].Species;
          }
          var cause = csvdata[i].CausesOfExtinction;
          // On parcourt le json
          for (var j = 0; j < jsondata.features.length; j++) {
            // Si le pays dans le json est contenu dans celui dans la ligne actuelle du csv
            if (country.indexOf(jsondata.features[j].properties.name) > -1) {
              // On incrémente le nombre d'espèces disparues provenant de ce pays.
              jsondata.features[j].properties.nbspecies++;
              // On ajoute l'espèce à la liste des espèces disparues de ce pays
              jsondata.features[j].properties.speciesList.push(speciesName);
              // On ajoute la cause d'extinction
              jsondata.features[j].properties.extinctionCauses.push(cause);
            }
          }
        }
        //console.log(jsondata);

        g.selectAll("path")
          .data(jsondata.features)
          .enter()
          .append("path")
          .on("mousemove", function (event, d) {
            tooltip
              .classed("hidden", false)
              // on positionne le tooltip en fonction
              // de la position de la souris
              .attr(
                "style",
                "left:" + (event.x + 15) + "px; top:" + (event.y - 15) + "px"
              )
              // Le tooltip contient le nom du pays et son nombre d'espèces disparues
              .html(
                "<div><b>Country : </b>" +
                  d.properties.name +
                  "<br /><b>Species extincted : </b>" +
                  d.properties.nbspecies +
                  "</div>"
              );
          })
          .on("mouseout", function (event, d) {
            tooltip.classed("hidden", true);
          })
          .on("click", function (event, d) {
            document.getElementById("generalInfos").innerHTML =
              "<h2>Selected country : " +
              d.properties.name +
              "</h2><ul id='speciesList'></ul><h3>Number of species extincted in this country : " +
              d.properties.nbspecies +
              "</h3>";
            // TODO: Ajouter ci-dessous les fonctions pour afficher les graphes

            // Compte le nombre d'occurences de chaque cause d'extinction et
            // crée un object liant chaque cause avec son nombre d'occurence
            var freqCauses = d.properties.extinctionCauses.reduce(function (
              acc,
              curr
            ) {
              if (typeof acc[curr] == "undefined") {
                acc[curr] = 1;
              } else {
                acc[curr] += 1;
              }
              return acc;
            },
            {});
            var keys = Object.keys(freqCauses);
            var values = Object.values(freqCauses);
            // Appelle la fonction qui dessine le pie chart
            drawPieChart(keys, values);
          })

          // On colore la carte en fonction du nombre d'espèces disparues dans chaque pays
          .attr("fill", function (d) {
            var nbspecies = d.properties.nbspecies;
            if (nbspecies > 0) {
              return color(nbspecies);
            } else {
              // si pas de valeur alors en gris
              return "#C0C0C0";
            }
          })
          .attr("class", "country")
          .attr("d", path);
      });
    });
  </script>
</body>

