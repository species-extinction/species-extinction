<!DOCTYPE html>
<head>
  <meta charset="utf-8" />
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <link
    rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
  />
  <link
    rel="stylesheet"
    href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
  />
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="src/styles.css" />
</head>

<body>
  <h1>Extinction des animaux (Une courte intro du site ?)</h1>
  <div class="container" id="content">
    <!--button type="button" onclick="changeView()">Click Me!</button-->
    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a href="#mapContainer" class="nav-link active" data-toggle="tab">
          MapContainer
        </a>
      </li>
      <li class="nav-item">
        <a href="#courbeContainer" class="nav-link" data-toggle="tab">
          CourbeContainer
        </a>
      </li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="mapContainer">
        <div class="container">
          <div id="map"></div>
          <div id="infos">
            <div id="generalInfos">
              <h4>Ici on affichera les infos sur le pays sélectionné</h4>
            </div>
            <!-- Bar de navigation pour basculer entre les graphes-->
            <div id="graphs">
              <ul class="nav nav-tabs">
                <li class="nav-item">
                  <a
                    href="#graph1Container"
                    class="nav-link active"
                    data-toggle="tab"
                  >
                    Graph 1
                  </a>
                </li>
                <li class="nav-item">
                  <a href="#graph2Container" class="nav-link" data-toggle="tab">
                    Graph 2
                  </a>
                </li>
              </ul>
              <div class="tab-content">
                <div class="tab-pane fade show active" id="graph1Container">
                  <div id="graph1"></div>
                </div>
                <div class="tab-pane fade" id="graph2Container">
                  <div id="graph2"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="courbeContainer">
        <div id="courbe"></div>
      </div>
    </div>
  </div>
  <script>
    // change de vue entre la map et la courbe
    /*
    function changeView() {
      if (!document.getElementById("map").hidden) {
        document.getElementById("map").hidden = true;
        document.getElementById("infos").hidden = true;
        document.getElementById("courbe").hidden = false;
      } else {
        document.getElementById("map").hidden = false;
        document.getElementById("infos").hidden = false;
        document.getElementById("courbe").hidden = true;
      }
    }
    */
    var width = 1500,
      height = 1500;

    // La carte
    var svg = d3
      .select("#map")
      .append("svg")
      .attr("viewBox", "250 400 1200 1200")
      .attr("preserveAspectRatio", "xMinYMin meet");

    var tooltip = d3
      .select("body")
      .append("div")
      .attr("class", "hidden tooltip");

    // On rajoute un groupe englobant toute la visualisation de la carte pour plus tard
    var g = svg.append("g");

    // Carte du monde
    projection = d3
      .geoNaturalEarth1()
      .translate([width / 2, height / 2])
      .scale(225);

    var path = d3.geoPath().projection(projection);

    // Range et Domain pour la coloration de la carte
    var color = d3
      .scaleQuantize()
      .range([
        "#ffffcc",
        "#ffff7f",
        "#ffff00",
        "#ffbf7f",
        "#ffb266",
        "#ff8000",
        "#ff4c4c",
        "#ff0000",
        "#7f0000"
      ])
      .domain([1, 50]);

    var countrySelected;

    // Des variables pour le piechart
    var pieheight = 350;
    var piewidth = 350;
    var piesvg = d3
      .select("#graph1")
      .append("svg")
      .attr("viewBox", "0 0 350 350")
      .attr("preserveAspectRatio", "xMinYMin meet")
      .append("g")
      .attr(
        "transform",
        "translate(" + piewidth / 2 + "," + pieheight / 2 + ")"
      );

    // Lolipop chart
    var lolimargin = { top: 10, right: 20, bottom: 50, left: 100 },
      loliwidth = 300 - lolimargin.left - lolimargin.right,
      loliheight = 350 - lolimargin.top - lolimargin.bottom;

    var lolisvg = d3
      .select("#graph2")
      .append("svg")
      .attr("viewBox", "40 0 250 350")
      .append("g")
      .attr(
        "transform",
        "translate(" + lolimargin.left + "," + lolimargin.top + ")"
      );

    function frequencies(data) {
      var freq = data.reduce(function (acc, curr) {
        if (typeof acc[curr] == "undefined") {
          acc[curr] = 1;
        } else {
          acc[curr] += 1;
        }
        return acc;
      }, {});
      return freq;
    }

    // Dessine le pie chart des causes d'extinctions
    function drawPieChart(keys, values) {
      //Pour effacer le précédent affichage
      piesvg.selectAll("path").remove();
      var piecolor = d3.interpolateRainbow;

      // Génère le pie chart
      var pie = d3.pie().value(function (d) {
        return d;
      });
      // Génère les arcs/parties du pie chart
      var arc = d3
        .arc()
        .innerRadius(0)
        .outerRadius(pieheight / 2);

      // Trace les parties du graphe
      piesvg
        .selectAll("arc")
        .data(pie(values))
        .enter()
        .append("path")
        .attr("d", arc)
        .attr("fill", function (d, i) {
          return piecolor(i / values.length);
        })
        .attr("stroke", "black")
        .style("stroke-width", "1px")
        .style("opacity", 0.8)
        .on("mousemove", function (event, d) {
          //console.log(d);
          tooltip
            .classed("hidden", false)
            .attr(
              "style",
              "left:" + (event.x + 15) + "px; top:" + (event.y - 15) + "px"
            )
            // Le tooltip contient la cause d'extinction représentée par la partie survolée
            // et le nombre d'espèces disparues par cette cause.
            .html(
              "<div><b>Cause of extinction : </b>" +
                keys[d.index] +
                "<br /><b>Species extincted by this cause : </b>" +
                d.value +
                "</div>"
            );
        })
        .on("mouseout", function (event, d) {
          tooltip.classed("hidden", true);
        });
    }

    function drawLoli(data) {
      lolisvg.selectAll("line").remove();
      lolisvg.selectAll("circle").remove();
      lolisvg.selectAll("g").remove();
      console.log(data);
      // Add X axis
      var x = d3
        .scaleLinear()
        .domain([0, Math.max(...Object.values(data))])
        .range([0, loliwidth]);
      lolisvg
        .append("g")
        .attr("transform", "translate(0," + loliheight + ")")
        .call(d3.axisBottom(x))
        .selectAll("text")
        .attr("transform", "translate(-10,0)rotate(-45)")
        .style("text-anchor", "end");

      // Y axis
      var y = d3
        .scaleBand()
        .range([0, loliheight])
        .domain(Object.keys(data))
        .padding(1);
      lolisvg.append("g").call(d3.axisLeft(y));

      // Lines
      lolisvg
        .selectAll("myline")
        .data(Object.entries(data))
        .enter()
        .append("line")
        .attr("x1", x(0))
        .attr("x2", function (d) {
          return x(d[1]);
        })
        .attr("y1", function (d) {
          return y(d[0]);
        })
        .attr("y2", function (d) {
          return y(d[0]);
        })
        .attr("stroke", "black");

      // Circles
      lolisvg
        .selectAll("mycircle")
        .data(Object.entries(data))
        .enter()
        .append("circle")
        .attr("cx", function (d) {
          return x(d[1]);
        })
        .attr("cy", function (d) {
          return y(d[0]);
        })
        .attr("r", "4")
        .style("fill", "#69b3a2")
        .attr("stroke", "black")
        .on("mousemove", function (event, d) {
          tooltip
            .classed("hidden", false)
            // on positionne le tooltip en fonction
            // de la position de la souris
            .attr(
              "style",
              "left:" +
                (event.x - loliwidth) +
                "px; top:" +
                (event.y - 15) +
                "px"
            )
            // Le tooltip contient le nom du pays et son nombre d'espèces disparues
            .html(
              "<div><b>" +
                d[0] +
                "</b><br /><b>Number of species : </b>" +
                d[1] +
                "</div>"
            );
        })
        .on("mouseout", function (event, d) {
          tooltip.classed("hidden", true);
        });
    }

    // On lit le fichier csv
    d3.dsv(";", "extinct_species.csv").then(function (csvdata) {
      // On lit le fichier json
      d3.json("world.geojson").then(function (jsondata) {
        jsondata.features.forEach((e) => {
          e.properties.nbspecies = 0;
          e.properties.speciesList = [];
          e.properties.extinctionCauses = [];
          e.properties.habitats = [];
        });

        var data_decade = [];
        for (var i = 0; i < 20; i++) {
          data_decade.push({ date: 1820 + 10 * i, nb: 0 });
        }

        // On parcourt le csv et on récupère le pays et le nom de l'espèce de la ligne courante
        for (var i = 0; i < csvdata.length; i++) {
          var country = csvdata[i].FormerDistribution;
          var speciesName = csvdata[i].CommonName;

          // traitement de la date
          var date = csvdata[i].EstimatedExtinctionDate;
          date = Number(date);
          if ((typeof date == "number", date)) {
            // console.log(date, typeof date, Math.floor(date / 10) - 182);
            var d = Math.floor(date / 10) - 182;
            if (d > 0) {
              data_decade[d].nb++;
            }
          }

          // Certaines espèces n'ont pas de nom commun donc on prend le nom scientifique
          if (speciesName == "Unknown") {
            speciesName = csvdata[i].Species;
          }
          var cause = csvdata[i].CausesOfExtinction;
          var habitat = csvdata[i].Habitat;
          // On parcourt le json
          for (var j = 0; j < jsondata.features.length; j++) {
            // Si le pays dans le json est contenu dans celui dans la ligne actuelle du csv
            if (country.indexOf(jsondata.features[j].properties.name) > -1) {
              // On incrémente le nombre d'espèces disparues provenant de ce pays.
              jsondata.features[j].properties.nbspecies++;
              // On ajoute l'espèce à la liste des espèces disparues de ce pays
              jsondata.features[j].properties.speciesList.push(speciesName);
              // On ajoute la cause d'extinction (seulement si elle est connue)
              if (cause != "Unknown") {
                jsondata.features[j].properties.extinctionCauses.push(cause);
              }
              // On ajoute le type d'habitat
              jsondata.features[j].properties.habitats.push(habitat);
            }
          }
        }
        //console.log(jsondata);

        g.selectAll("path")
          .data(jsondata.features)
          .enter()
          .append("path")
          .on("mousemove", function (event, d) {
            tooltip
              .classed("hidden", false)
              // on positionne le tooltip en fonction
              // de la position de la souris
              .attr(
                "style",
                "left:" + (event.x + 15) + "px; top:" + (event.y - 15) + "px"
              )
              // Le tooltip contient le nom du pays et son nombre d'espèces disparues
              .html(
                "<div><b>Country : </b>" +
                  d.properties.name +
                  "<br /><b>Species extincted : </b>" +
                  d.properties.nbspecies +
                  "</div>"
              );
          })
          .on("mouseout", function (event, d) {
            tooltip.classed("hidden", true);
          })
          .on("click", function (event, d) {
            if (countrySelected != undefined) {
              countrySelected.attr("stroke-width", 1).attr("stroke", "#ffffff");
            }
            countrySelected = d3.select(this);
            countrySelected.attr("stroke-width", 2).attr("stroke", "#00004c");

            document.getElementById("generalInfos").innerHTML =
              "<h4>" +
              d.properties.name +
              "</h4><ul id='speciesList'></ul><h5>Number of species extincted in this country : " +
              d.properties.nbspecies +
              "</h5>";
            // TODO: Ajouter ci-dessous les fonctions pour afficher les graphes

            // Compte le nombre d'occurences de chaque cause d'extinction et
            // crée un object liant chaque cause avec son nombre d'occurence
            freqCauses = frequencies(d.properties.extinctionCauses);
            var keys = Object.keys(freqCauses);
            var values = Object.values(freqCauses);
            // Appelle la fonction qui dessine le pie chart
            drawPieChart(keys, values);

            freqHabitats = frequencies(d.properties.habitats);
            drawLoli(freqHabitats);
          })

          // On colore la carte en fonction du nombre d'espèces disparues dans chaque pays
          .attr("fill", function (d) {
            var nbspecies = d.properties.nbspecies;
            if (nbspecies > 0) {
              return color(nbspecies);
            } else {
              // si pas de valeur alors en gris
              return "#C0C0C0";
            }
          })
          .attr("class", "country")
          .attr("d", path);

        // ================================================
        // creer le graph qui decrit l'augmentation du nombre d'extinction au cours du temps

        // set the dimensions and margins of the graph
        var margin_c = { top: 10, right: 30, bottom: 100, left: 100 },
          width_c = 1000 - margin_c.left - margin_c.right,
          height_c = 500 - margin_c.top - margin_c.bottom;

        // append the svg object to the body of the page
        var svg_c = d3
          .select("#courbe")
          .append("svg")
          .attr("width", width_c + margin_c.left + margin_c.right)
          .attr("height", height_c + margin_c.top + margin_c.bottom)
          .append("g")
          .attr(
            "transform",
            "translate(" + margin_c.left + "," + margin_c.top + ")"
          );

        // Add X axis --> it is a date format
        var x = d3
          .scaleTime()
          .domain(
            d3.extent(data_decade, function (d) {
              return d.date;
            })
          )
          .range([0, width_c]);

        svg_c
          .append("g")
          .attr("transform", "translate(0," + height_c + ")")
          .call(d3.axisBottom(x));

        // Add Y axis
        var y = d3
          .scaleLinear()
          .domain([
            0,
            d3.max(data_decade, function (d) {
              return d.nb;
            })
          ])
          .range([height_c, 0]);

        svg_c.append("g").call(d3.axisLeft(y));

        // Add the area
        svg_c
          .append("path")
          .datum(data_decade)
          .attr("fill", "#cce5df")
          .attr("stroke", "#69b3a2")
          // .attr("stroke", "#69b3a2")
          .attr("stroke-width", 1.5)
          .attr(
            "d",
            d3
              .area()
              .x(function (d) {
                return x(d.date);
              })
              .y0(y(0))
              .y1(function (d) {
                return y(d.nb);
              })
          );
      });
    });
  </script>
</body>
